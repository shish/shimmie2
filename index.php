<?php
/**
 * \mainpage Shimmie2 / SCore Documentation
 *
 * SCore is a framework designed for writing flexible, extendable applications.
 * Whereas most PHP apps are built monolithically, score's event-based nature
 * allows parts to be mixed and matched. For instance, the most famous
 * collection of score extensions is the Shimmie image board, which includes
 * user management, a wiki, a private messaging system, etc. But one could
 * easily remove the image board bits and simply have a wiki with users and
 * PMs; or one could replace it with a blog module; or one could have a blog
 * which links to images on an image board, with no wiki or messaging, and so
 * on and so on...
 *
 * Dijkstra will kill me for personifying my architecture, but I can't think
 * of a better way without going into all the little details.
 * There are a bunch of Extension subclasses, they talk to each other by sending
 * and receiving  Event subclasses. The primary driver for each conversation is the
 * initial PageRequestEvent. If an Extension wants to display something to the
 * user, it adds a block to the Page data store. Once the conversation is over, the Page is passed to the
 * current theme's Layout class which will tidy up the data and present it to
 * the user. To see this in a more practical sense, see \ref hello.
 *
 * To learn more about the architecture:
 *
 * \li \ref eande
 * \li \ref themes
 *
 * To learn more about practical development:
 *
 * \li \ref scglobals
 * \li \ref unittests
 *
 * \page scglobals SCore Globals
 *
 * There are four global variables which are pretty essential to most extensions:
 *
 * \li $config -- some variety of Config subclass
 * \li $database -- a Database object used to get raw SQL access
 * \li $page -- a Page to holds all the loose bits of extension output
 * \li $user -- the currently logged in User
 *
 * Each of these can be imported at the start of a function with eg "global $page, $user;"
 */

if(!file_exists("data/config/shimmie.conf.php")) {
	header("Location: install.php");
	exit;
}

if(!file_exists("vendor/")) {
	//CHECK: Should we just point to install.php instead? Seems unsafe though.
	print <<<EOD

<!DOCTYPE html>
<html>
	<head>
		<title>Shimmie Error</title>
		<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAIAICAAAAEAIACoEAAAJgAAABAQAAABAAgAaAUAAM4QAAAoAAAAIAAAAEAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA1wAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA0wAAABYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/Z2dn/2dnZ/9nZ2f/Z2dn/2ZmZv9mZmb/ZmZm/2ZmZv9mZmb/ZWVl/2VlZf9lZWX/ZWVl/2VlZf9lZWX/ZGRk/2RkZP9kZGT/AAAA/wAAAP8AAAD/AAAA1wAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP9paWn/aWlp/2lpaf9paWn/aGho/2hoaP9oaGj/aGho/2hoaP9oaGj/Z2dn/2dnZ/9nZ2f/Z2dn/2dnZ/9nZ2f/ZmZm/2ZmZv8AAAD/AAAA/xISEv8AAAD/AAAA1wAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/2tra/9ra2v/a2tr/2tra/9qamr/ampq/2pqav9qamr/ampq/2pqav9paWn/aWlp/2lpaf9paWn/aWlp/2lpaf9oaGj/aGho/wAAAP8AAAD/X19f/xISEv8AAAD/AAAA1wAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/bW1t/21tbf9tbW3/bW1t/21tbf9sbGz/bGxs/2xsbP9sbGz/bGxs/2xsbP9ra2v/a2tr/2tra/9ra2v/a2tr/2pqav9qamr/AAAA/wAAAP9qamr/YWFh/xMTE/8AAAD/AAAA1wAAABgAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP9vb2//b29v/29vb/9vb2//b29v/25ubv9ubm7/bm5u/25ubv9ubm7/bm5u/21tbf9tbW3/bW1t/21tbf9tbW3/bW1t/2xsbP8AAAD/AAAA/2xsbP9sbGz/Y2Nj/xISEv8AAAD/AAAA0wAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/3Fxcf9xcXH/cXFx/3Fxcf9xcXH/cXFx/3BwcP9wcHD/cHBw/3BwcP9wcHD/b29v/29vb/9vb2//b29v/29vb/9vb2//bm5u/wAAAP8AAAD/bm5u/25ubv9ubm7/ZGRk/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/c3Nz/3Nzc/9zc3P/c3Nz/3Nzc/9zc3P/cnJy/3Jycv9ycnL/cnJy/3Jycv9ycnL/cXFx/3Fxcf9xcXH/cXFx/3Fxcf9xcXH/AAAA/wAAAP9wcHD/cHBw/3BwcP9vb2//AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP92dnb/dXV1/3V1df91dXX/dXV1/3V1df90dHT/dHR0/3R0dP90dHT/dHR0/3R0dP9zc3P/c3Nz/3Nzc/9zc3P/c3Nz/3Nzc/8AAAD/AAAA/3Jycv9ycnL/cnJy/3Jycv8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/3h4eP93d3f/d3d3/3d3d/93d3f/d3d3/3d3d/92dnb/dnZ2/3Z2dv92dnb/dnZ2/3Z2dv91dXX/dXV1/3V1df91dXX/dXV1/wAAAP8AAAD/dHR0/3R0dP90dHT/dHR0/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/enp6/3l5ef95eXn/eXl5/3l5ef95eXn/eXl5/3h4eP94eHj/eHh4/3h4eP94eHj/eHh4/3d3d/93d3f/d3d3/3d3d/93d3f/AAAA/wAAAP92dnb/dnZ2/3Z2dv92dnb/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP98fHz/fHx8/3t7e/97e3v/e3t7/3t7e/97e3v/e3t7/3p6ev96enr/enp6/3p6ev96enr/eXl5/3l5ef95eXn/eXl5/3l5ef8AAAD/AAAA/3h4eP94eHj/eHh4/3h4eP8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/35+fv9+fn7/fX19/319ff99fX3/fX19/319ff99fX3/fHx8/3x8fP98fHz/fHx8/3x8fP98fHz/e3t7/3t7e/97e3v/e3t7/wAAAP8AAAD/enp6/3p6ev96enr/enp6/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/gICA/4CAgP+AgID/f39//39/f/9/f3//f39//39/f/9+fn7/fn5+/35+fv9+fn7/fn5+/35+fv99fX3/fX19/319ff99fX3/AAAA/wAAAP98fHz/fHx8/3x8fP98fHz/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP+CgoL/goKC/4KCgv+BgYH/gYGB/4GBgf+BgYH/gYGB/4GBgf+AgID/gICA/4CAgP+AgID/gICA/4CAgP9/f3//f39//39/f/8AAAD/AAAA/35+fv9+fn7/fn5+/35+fv8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/4SEhP+EhIT/hISE/4ODg/+Dg4P/g4OD/4ODg/+Dg4P/g4OD/4KCgv+CgoL/goKC/4KCgv+CgoL/goKC/4GBgf+BgYH/gYGB/wAAAP8AAAD/gYGB/4CAgP+AgID/gICA/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/hoaG/4aGhv+Ghob/hoaG/4WFhf+FhYX/hYWF/4WFhf+FhYX/hYWF/4SEhP+EhIT/hISE/4SEhP+EhIT/g4OD/4ODg/+Dg4P/AAAA/wAAAP+Dg4P/goKC/4KCgv+CgoL/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA/wAAAP+IiIj/iIiI/4iIiP+IiIj/h4eH/4eHh/+Hh4f/h4eH/4eHh/+Hh4f/hoaG/4aGhv+Ghob/hoaG/4aGhv+Ghob/hYWF/4WFhf8AAAD/AAAA/4WFhf+FhYX/hISE/4SEhP8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/4qKiv+Kior/ioqK/4qKiv+Kior/iYmJ/4mJif+JiYn/iYmJ/4mJif+IiIj/iIiI/4iIiP+IiIj/iIiI/4iIiP+Hh4f/h4eH/wAAAP8AAAD/h4eH/4eHh/+Ghob/hoaG/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP99fX3/iYmJ/4iIiP+IiIj/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAA0wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/xgYGP9/f3//i4uL/4qKiv8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAVAAAA0gAAAP8XFxf/goKC/5CQkP+QkJD/kJCQ/4+Pj/+Pj4//j4+P/4+Pj/+Pj4//j4+P/46Ojv+Ojo7/jo6O/46Ojv+Ojo7/jY2N/4GBgf8ZGRn/AAAA/xYWFv+AgID/jIyM/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVAAAA0gAAAP8XFxf/hISE/5KSkv+SkpL/kZGR/5GRkf+RkZH/kZGR/5GRkf+RkZH/kJCQ/5CQkP+QkJD/kJCQ/5CQkP+QkJD/j4+P/4ODg/8ZGRn/AAAA/xYWFv+CgoL/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVAAAA0gAAAP8XFxf/hoaG/5SUlP+UlJT/k5OT/5OTk/+Tk5P/k5OT/5OTk/+SkpL/kpKS/5KSkv+SkpL/kpKS/5KSkv+RkZH/kZGR/4WFhf8aGhr/AAAA/xcXF/8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVAAAA0gAAAP8YGBj/iIiI/5aWlv+VlZX/lZWV/5WVlf+VlZX/lZWV/5WVlf+UlJT/lJSU/5SUlP+UlJT/lJSU/5OTk/+Tk5P/k5OT/4eHh/8aGhr/AAAA/wAAAP8AAAD/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWAAAA0wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVAAAA0gAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////wAAA/8AAAH/AAAA/wAAAH8AAAA/AAAAHwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA+AAAAPwAAAD+AAAA/wAAAP+AAAD/wAAA///////////KAAAABAAAAAgAAAAAQAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYWFgB9fX0Af39/AICAgACBgYEAg4ODAISEhACGhoYAh4eHAImJiQCKiooAjIyMAI+PjwCQkJAAkpKSAJOTkwCVlZUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAREREREREREREREREREREREQAAAAAAAAAAAAAAEREREREAAQEBAQEBAQEBAAARERERAAEBAQEBAQEBAQABABEREQABAQEBAQEBAQEAAQEAEREAAQEBAQEBAQEBAAEBABERAAYGBQQDAgEBAQACAQAREQAMDAwLCwoJCQcACQgAEREAEBAQEBAQDg4MAA0NABERABAQEBAQEBAQEAAQEAAREQAQEBAQEBAQEBAAEBAAEREAAAAAAAAAAAAAABAQABEREQAQEA8QEBAQEBAAEAARERERABAQEBAQEA8QEAAAEREREREAAAAAAAAAAAAAABERERERERERERERERERERER//8AAIAPAACABwAAgAMAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAwAEAAOABAADwAQAA//8AAA==" />
		<style>
			#installer { background: #EEE; font-family: "Arial", sans-serif; font-size: 14px; width: 512px; margin: auto; margin-top: 16px; border: 1px solid black; border-radius: 16px; }
			#installer > .container { padding: 5px; }
			#installer A { text-decoration: none; }
			#installer A:hover { text-decoration: underline; }
			#installer H1, #installer H3 { background: #DDD; text-align: center; margin: 0px; padding: 2px; }
			#installer H1 { border-bottom: 1px solid black; border-radius: 16px 16px 0px 0px; }
			#installer H3 { border-bottom: 1px solid black; }
		</style>
	</head>
	<body>
		<div id="installer">
			<h1>Install Error</h1>
			<h3>Warning: Composer vendor folder does not exist!</h3>
			<div class="container">
				<p>Shimmie is unable to find the composer vendor directory.<br>
				Have you followed the composer setup instructions found in the <a href="https://github.com/shish/shimmie2#installation-development">README</a>?</>

				<p>If you are not intending to do any development with Shimmie, it is highly recommend you use one of the pre-packaged releases found on <a href="https://github.com/shish/shimmie2/releases">Github</a> instead.</p>
			</div>
		</div>
	</body>
</html>
EOD;
	http_response_code(500);
	exit;
}

try {
	require_once "core/_bootstrap.inc.php";
	ctx_log_start(@$_SERVER["REQUEST_URI"], true, true);

	// start the page generation waterfall
	$user = _get_user();
	if(PHP_SAPI === 'cli') {
		send_event(new CommandEvent($argv));
	}
	else {
		send_event(new PageRequestEvent(_get_query()));
		$page->display();
	}

	// saving cache data and profiling data to disk can happen later
	if(function_exists("fastcgi_finish_request")) fastcgi_finish_request();
	$database->commit();
	ctx_log_endok();
}
catch(Exception $e) {
	if($database) $database->rollback();
	_fatal_error($e);
	ctx_log_ender();
}

